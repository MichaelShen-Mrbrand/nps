name: Compile for ARMv7 (Softfloat)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4


    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.25'
        cache: true

    - name: Prepare build environment
      run: |
        # 安装交叉编译工具链（对于纯 Go 项目非必需，但为确保兼容性）
        sudo apt-get update
        sudo apt-get install -y gcc-arm-linux-gnueabihf

    - name: Compile NPC (Client) for ARMv7 Softfloat
      run: |
        # 关键改动：使用 GOARM=6 以生成软浮点代码，避免 vfp 指令
        export GOOS=linux
        export GOARCH=arm
        export GOARM=6  # <--- 核心修正点
        export CGO_ENABLED=0

        # 编译 NPC
        go build -ldflags "-s -w -extldflags -static" -o npc_linux_armv7_softfloat ./cmd/npc/npc.go

        # 打包 NPC 和配置文件
        mkdir -p npc_dist
        cp npc_linux_armv7_softfloat npc_dist/npc
        cp -r conf/npc.conf conf/multi_account.conf npc_dist/
        tar -czvf npc_linux_armv7_softfloat.tar.gz -C npc_dist .

    - name: Compile NPS (Server) for ARMv7 Softfloat
      run: |
        # 关键改动：使用 GOARM=6 以生成软浮点代码，避免 vfp 指令
        export GOOS=linux
        export GOARCH=arm
        export GOARM=6  # <--- 核心修正点
        export CGO_ENABLED=0

        # 编译 NPS
        go build -ldflags "-s -w -extldflags -static" -o nps_linux_armv7_softfloat ./cmd/nps/nps.go

        # 打包 NPS 和配置文件、网页资源
        mkdir -p nps_dist
        cp nps_linux_armv7_softfloat nps_dist/nps
        cp -r conf/nps.conf web/ nps_dist/
        tar -czvf nps_linux_armv7_softfloat.tar.gz -C nps_dist .

    - name: Upload NPC Artifact
      uses: actions/upload-artifact@v4
      with:
        name: npc-linux-armv7-softfloat
        path: npc_linux_armv7_softfloat.tar.gz

    - name: Upload NPS Artifact
      uses: actions/upload-artifact@v4
      with:
        name: nps-linux-armv7-softfloat
        path: nps_linux_armv7_softfloat.tar.gz
