name: Compile NPC and Build IPK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Compile NPC (Client) for ARMv7
        run: |
          export GOOS=linux
          export GOARCH=arm
          export GOARM=5
          export CGO_ENABLED=0

          go build -tags=softfloat \
                   -ldflags "-s -w -extldflags -static" \
                   -o npc_linux_armv7_minimal ./cmd/npc/npc.go

          mkdir -p npc_dist/usr/bin
          mkdir -p npc_dist/usr/lib/nps/conf
          cp npc_linux_armv7_minimal npc_dist/usr/bin/npc
          cp -r conf/npc.conf conf/multi_account.conf npc_dist/usr/lib/nps/conf/
          tar -czvf npc-linux-armv7-minimal.tar.gz -C npc_dist .

      - name: Install IPK Build Tools (ipkg-utils)
        run: |
          # 添加 Debian Buster 归档源
          echo "deb [trusted=yes] http://archive.debian.org/debian buster main" | sudo tee /etc/apt/sources.list.d/debian-buster.list
          
          # 更新源列表，忽略证书错误和过期警告
          sudo apt-get update -o Acquire::Check-Valid-Until=false -o Acquire::AllowInsecureRepositories=true -y
          
          # 安装 ipkg-utils
          sudo apt-get install -y ipkg-utils
          
          # 移除临时添加的源
          sudo rm /etc/apt/sources.list.d/debian-buster.list

      - name: Create IPK Package Structure
        run: |
          PKG_NAME="npc"
          PKG_VERSION="0.33.11"
          PKG_RELEASE="1"
          PKG_ARCH="arm_cortex-a9" # 你的设备架构

          mkdir -p "${PKG_NAME}_ipk/control"
          mkdir -p "${PKG_NAME}_ipk/data"

          cp -r npc_dist/* "${PKG_NAME}_ipk/data/"

          cat > "${PKG_NAME}_ipk/control/control" << EOF
          Package: ${PKG_NAME}
          Version: ${PKG_VERSION}-${PKG_RELEASE}
          Architecture: ${PKG_ARCH}
          Maintainer: Your Name <your.email@example.com>
          Section: net
          Priority: optional
          Description: NPS Client (NPC) - Fast reverse proxy (Custom Compiled)
           This package contains the client program for the NPS reverse proxy.
           It allows you to expose intranet services to the public network.
           Custom built for ARMv7 with softfloat support.
          EOF

      - name: Build IPK Package
        run: |
          PKG_NAME="npc"
          ipkg-build -o root -g root "${PKG_NAME}_ipk" .

      - name: Upload NPC Binary Artifact
        uses: actions/upload-artifact@v4
        with:
          name: npc-linux-armv7-minimal-binary
          path: npc-linux-armv7-minimal.tar.gz

      - name: Upload IPK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: npc-openwrt-ipk
          path: "*.ipk"
