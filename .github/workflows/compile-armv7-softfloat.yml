name: Compile for ARMv7 (Minimal Softfloat)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        # 若需编译 v0.33.11，取消下方注释
        # with:
        #   ref: 'v0.33.11'

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'  # 降低 Go 版本，减少对新指令的依赖（关键！）
          cache: true

      - name: Compile NPC (Minimal Softfloat)
        run: |
          export GOOS=linux
          export GOARCH=arm
          export GOARM=6  # 软浮点
          export CGO_ENABLED=0
          # 关键新增：-tags=softfloat 强制禁用硬件浮点；-ldflags 禁用 thumb 指令
          go build -tags=softfloat \
                   -ldflags "-s -w -extldflags -static -mthumb=false" \
                   -o npc_linux_armv7_minimal ./cmd/npc/npc.go

          # 打包
          mkdir -p npc_dist
          cp npc_linux_armv7_minimal npc_dist/npc
          cp -r conf/npc.conf conf/multi_account.conf npc_dist/
          tar -czvf npc_linux_armv7_minimal.tar.gz -C npc_dist .

      - name: Upload Minimal NPC Artifact
        uses: actions/upload-artifact@v4
        with:
          name: npc-linux-armv7-minimal
          path: npc_linux_armv7_minimal.tar.gz
